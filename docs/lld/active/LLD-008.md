# 10008 - Feature: Spec vs Extended Output Comparison Quality Gate

## 1. Context & Goal
* **Issue:** #8
* **Objective:** Create a CI quality gate that compares CSV outputs from both extraction pipelines
* **Status:** Approved
* **Related Issues:** None
* **Effort Estimate:** S (Small)

### Open Questions
*Questions that need clarification before or during implementation. Remove when resolved.*

- [x] Can we guarantee identical row ordering in both pipelines? **Decision: Require sorting by sample_number before comparison**
- [x] Should extra rows in Extended be allowed (superset) or flagged? **Decision: PASS - subset verification only**
- [ ] Should comparison ignore specific columns (e.g., `processed_at` timestamps)?

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describe exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `scripts/compare_outputs.py` | Add | Streaming CSV comparison script |
| `.github/workflows/ci.yml` | Modify | Add comparison step after both pipelines |
| `tests/fixtures/spec.csv` | Add | Test fixture for comparison |
| `tests/fixtures/extended_match.csv` | Add | Matching extended fixture |
| `tests/fixtures/extended_mismatch.csv` | Add | Mismatching extended fixture |

### 2.2 Dependencies

*New packages, APIs, or services required.*

```toml
# No new dependencies - uses Python standard library only
# csv, argparse, sys, os, pathlib
```

### 2.3 Data Structures

```python
# Custom exceptions for distinct exit codes
class SecurityError(Exception):
    """Raised when path validation fails (directory traversal attempt)."""
    pass

class EnvironmentError(Exception):
    """Raised for file not found, permission denied, etc."""
    pass

class DataMismatchError(Exception):
    """Raised when comparison finds differences."""
    pass

# Exit codes
EXIT_SUCCESS = 0        # Comparison passed
EXIT_DATA_MISMATCH = 1  # Data differences found
EXIT_ENV_ERROR = 2      # Environmental error (file not found, permissions)
```

### 2.4 Function Signatures

```python
# scripts/compare_outputs.py

def parse_args() -> argparse.Namespace:
    """Parse command line arguments with help and exit code docs.

    Includes --ignore-cols for excluding timestamp fields from comparison.
    """
    ...

def get_repo_root() -> Path:
    """Determine repository root directory.

    Primary: pathlib.Path(__file__).resolve().parents[1]
    Fallback: git rev-parse --show-toplevel
    """
    ...

def validate_path(file_path: str, repo_root: Path) -> Path:
    """Validate file path is within repo root (prevent directory traversal).

    Uses pathlib.Path.resolve() to get absolute path and compares against repo root.

    Args:
        file_path: User-provided file path
        repo_root: Repository root directory

    Returns:
        Resolved Path object if valid

    Raises:
        SecurityError: If path resolves outside repo root (FAIL CLOSED, exit code 1)
    """
    ...

def validate_sorting(csv_path: Path, key_column: str = "sample_number") -> bool:
    """Validate CSV is sorted by key column for deterministic comparison.

    Args:
        csv_path: Path to CSV file
        key_column: Column to check sorting on

    Returns:
        True if sorted, False otherwise
    """
    ...

def is_null_equivalent(value: str) -> bool:
    """Check if value represents null ('', 'NA', 'NaN')."""
    ...

def compare_outputs(spec_path: str, extended_path: str, verbose: bool = False) -> int:
    """Compare two CSV files using true streaming.

    Returns:
        EXIT_SUCCESS (0): Comparison passed
        EXIT_DATA_MISMATCH (1): Data differences found
        EXIT_ENV_ERROR (2): Environmental error (file not found, etc.)
    """
    ...
```

### 2.5 Logic Flow (Pseudocode)

```
1. Parse arguments (spec_path, extended_path, --verbose, --ignore-cols)
2. Determine repo_root:
   - Method: pathlib.Path(__file__).resolve().parents[1]
   - Fallback: subprocess.run(['git', 'rev-parse', '--show-toplevel'])
3. TRY:
   - Validate paths using pathlib.Path.resolve()
   - IF path outside repo root: raise SecurityError, exit 2
   EXCEPT SecurityError:
   - Log "Security: Path outside repository", exit 2
4. TRY:
   - Verify files exist
   EXCEPT FileNotFoundError:
   - Log "Environment: File not found", exit 2
5. Validate both files are sorted by sample_number
   - IF not sorted: FATAL ERROR, exit 2
   - (Streaming zip() comparison REQUIRES sorted input)
6. Open both files for streaming
7. Read headers from both files
8. Verify all Spec columns exist in Extended
   - Extra columns in Extended: OK (subset verification)
   - IF --ignore-cols specified: exclude those columns from comparison
9. FOR each row pair (using zip on iterators):
   a. FOR each Spec column (excluding ignored):
      - Compare values (treating '', 'NA', 'NaN' as equivalent)
      - Record mismatches
10. After zip exhausts:
    - IF Spec has remaining rows: FAIL (Extended missing data)
    - IF Extended has remaining rows: PASS (superset OK)
11. Report results:
    - PASS: Exit 0, show row/column counts
    - DATA MISMATCH: Exit 1, show up to 20 differences (or all with --verbose)
    - ENV ERROR: Exit 2, show specific error
```

### 2.6 Technical Approach

* **Module:** `scripts/compare_outputs.py`
* **Pattern:** True streaming comparison using `zip()` on CSV reader iterators
* **Key Decisions:**
  - No `list()` conversion on readers (memory efficiency)
  - Subset verification (Extended may have extra columns/rows)
  - Row ordering assumed deterministic
  - Path validation prevents directory traversal attacks

## 3. Requirements

*What must be true when this is done. These become acceptance criteria.*

1. Script uses `argparse` with `--help` support including exit code documentation
2. Script uses standard library `csv` (not pandas)
3. Script streams files without loading entirely into memory
4. Script handles files >500MB without OOM on standard runners
5. Script verifies all Spec columns exist in Extended
6. Script verifies all Spec rows have matching Extended rows
7. Script treats empty string, 'NA', and 'NaN' as equivalent null values
8. Script outputs clear pass/fail with specific differences
9. **Exit codes:** 0=success, 1=data mismatch, 2=environmental error
10. Script validates file paths using `pathlib.Path.resolve()` to prevent directory traversal
11. Extra rows in Extended output: PASS (subset verification)
12. Extra columns in Extended output: PASS (subset verification)
13. Script validates both files are sorted by `sample_number` before comparison

## 4. Alternatives Considered

| Option | Pros | Cons | Decision |
|--------|------|------|----------|
| Pandas comparison | Simple API | Memory heavy, new dependency | **Rejected** |
| Hash-based comparison | Order-independent | Higher memory, complexity | **Rejected** |
| Streaming row-by-row | Memory efficient | Requires ordered rows | **Selected** |

**Rationale:** Streaming comparison handles large files within GitHub Actions memory limits while keeping implementation simple.

## 5. Data & Fixtures

### 5.1 Data Sources

| Attribute | Value |
|-----------|-------|
| Source | Pipeline output files |
| Format | CSV |
| Size | Up to 500MB+ |
| Refresh | Per CI run |
| Copyright/License | Generated data |

### 5.2 Data Pipeline

```
Spec pipeline ──► data/output/spec/core_analysis.csv ──┐
                                                       ├──► compare_outputs.py ──► PASS/FAIL
Extended pipeline ──► data/output/extended/core_analysis.csv ──┘
```

### 5.3 Test Fixtures

| Fixture | Source | Notes |
|---------|--------|-------|
| tests/fixtures/spec.csv | Generated | Small test CSV (sorted by sample_number) |
| tests/fixtures/extended_match.csv | Generated | Matching extended |
| tests/fixtures/extended_mismatch.csv | Generated | Value differences |
| tests/fixtures/extended_extra_cols.csv | Generated | Extra columns (should pass) |
| tests/fixtures/extended_extra_rows.csv | Generated | Extra rows (should pass - superset) |
| tests/fixtures/unsorted.csv | Generated | Unsorted for warning test |
| scripts/generate_large_csv.py | Generated | Script to create 500MB test file |

### 5.4 Deployment Pipeline

CI integration via GitHub Actions workflow.

## 6. Diagram

N/A - Simple comparison script, flow described in pseudocode.

## 7. Security Considerations

| Concern | Mitigation | Status |
|---------|------------|--------|
| Directory traversal | Validate paths with pathlib.Path.resolve() + repo root check | Addressed |
| No network access | Script reads local files only | Addressed |

**Fail Mode:** Fail Closed - Invalid paths raise `SecurityError` and return exit code 1.

**Path Validation Implementation:**
```python
def validate_path(file_path: str, repo_root: Path) -> Path:
    """Validate file path is within repo root."""
    resolved = Path(file_path).resolve()
    try:
        resolved.relative_to(repo_root.resolve())
        return resolved
    except ValueError:
        raise SecurityError(f"Path outside repository: {file_path}")
```

### 7.1 Logging Strategy

| Event | Level | Message Format |
|-------|-------|----------------|
| Comparison start | INFO | `Comparing {spec_path} vs {extended_path}` |
| Path validated | DEBUG | `Validated path: {path}` |
| Security violation | ERROR | `Security: Path outside repository: {path}` |
| File not found | ERROR | `Environment: File not found: {path}` |
| Sorting check | WARNING | `Files may not be sorted by sample_number - results may be incorrect` |
| Column mismatch | WARNING | `Missing columns in Extended: {columns}` |
| Comparison passed | INFO | `PASSED: {n} rows, {c} columns verified` |
| Comparison failed | INFO | `FAILED: {n} differences found` |

### 7.2 Exit Code Reference

| Code | Meaning | Example Cause |
|------|---------|---------------|
| 0 | Success | All Spec data found in Extended |
| 1 | Data Mismatch | Value differences, missing rows/columns |
| 2 | Environmental Error | File not found, permission denied, security violation |

## 8. Performance Considerations

| Metric | Budget | Approach |
|--------|--------|----------|
| Memory | < 7GB (GH Actions) | True streaming with zip() |
| Latency | < 60s for 500MB | Single-pass comparison |

**Bottlenecks:** Very large files may be slow but should complete within CI timeouts.

## 9. Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Row order differs | High | Med | Document requirement, investigate if needed |
| Memory OOM on large files | High | Low | True streaming, no list() |
| Flaky CI from timing | Low | Low | Comparison is deterministic |

## 10. Verification & Testing

### 10.1 Test Scenarios

| ID | Scenario | Type | Input | Expected Output | Pass Criteria |
|----|----------|------|-------|-----------------|---------------|
| 010 | Matching files | Auto | spec.csv, extended_match.csv | Exit 0, PASSED | Correct exit |
| 020 | Value mismatch | Auto | spec.csv, extended_mismatch.csv | Exit 1, diff shown | Correct exit |
| 030 | Missing column | Auto | spec.csv, missing_col.csv | Exit 1, column listed | Correct exit |
| 040 | Extra columns | Auto | spec.csv, extended_extra_cols.csv | Exit 0, PASSED | Subset passes |
| 050 | Missing file | Auto | nonexistent.csv | Exit 2, error msg | Env error code |
| 060 | Directory traversal | Auto | ../../../etc/passwd | Exit 2, security error | Blocked |
| 070 | Verbose mode | Auto | --verbose with mismatches | All diffs shown | No limit |
| 080 | Extra rows in Extended | Auto | spec.csv, extended_extra_rows.csv | Exit 0, PASSED | Superset passes |
| 090 | Large file (500MB) | Auto | generated_large.csv | Exit 0, no OOM | Memory < 7GB |
| 100 | Unsorted files | Auto | unsorted.csv | Exit 2, fatal error | Aborts comparison |
| 110 | Ignore cols flag | Auto | --ignore-cols processed_at | Exit 0 | Timestamp ignored |

### 10.2 Test Commands

```bash
# Test matching
python scripts/compare_outputs.py tests/fixtures/spec.csv tests/fixtures/extended_match.csv
# Expected: Exit 0

# Test mismatch
python scripts/compare_outputs.py tests/fixtures/spec.csv tests/fixtures/extended_mismatch.csv
# Expected: Exit 1

# Test directory traversal
python scripts/compare_outputs.py ../../../etc/passwd tests/fixtures/extended.csv
# Expected: Exit 1, "Invalid path"
```

### 10.3 Manual Tests (Only If Unavoidable)

N/A - All scenarios automated.

## 11. Definition of Done

### Code
- [ ] Implementation complete and linted
- [ ] Path validation implemented

### Tests
- [ ] All test scenarios pass
- [ ] Test coverage meets threshold

### Documentation
- [ ] LLD updated with any deviations
- [ ] Implementation Report completed
- [ ] CLI help text includes exit codes

### Review
- [ ] Code review completed
- [ ] CI workflow updated

---

## Appendix: Review Log

*Track all review feedback with timestamps and implementation status.*

### Gemini 3 Pro Review #1 (REVISE)

**Timestamp:** 2026-01-29
**Reviewer:** Gemini 3 Pro (Senior Software Architect & AI Governance Lead)
**Verdict:** REVISE

#### Comments

| ID | Comment | Implemented? |
|----|---------|--------------|
| G1.1 | "Worktree Scope Enforcement (BLOCKING): Mandate SecurityError and exit 1 for paths outside repo" | YES - Added Section 7 with SecurityError |
| G1.2 | "Fail-Safe Strategy (Row Mismatch) (BLOCKING): Clarify Extended extra rows behavior" | YES - Requirement 11: PASS for superset |
| G1.3 | "Directory Traversal (CRITICAL): Use pathlib.Path.resolve()" | YES - Added to Section 2.4 and 7 |
| G1.4 | "Deterministic Row Ordering: Validate sorting or document sort command" | YES - Added validate_sorting() and Requirement 13 |
| G1.5 | "Logging & Exit Codes: Add exit code 2 for environmental errors" | YES - Added Section 7.2 with 0/1/2 codes |
| G1.6 | "Test Integrity (Large File): Add 500MB test scenario" | YES - Added Scenario 090 |
| G1.7 | "Consider ignoring specific columns like processed_at" | DEFERRED - Added to Open Questions |

---

### Gemini 3 Pro Review #2 (APPROVED)

**Timestamp:** 2026-01-30
**Reviewer:** Gemini 3 Pro (Senior Software Architect & AI Governance Lead)
**Verdict:** APPROVED

#### Comments

| ID | Comment | Implemented? |
|----|---------|--------------|
| G2.1 | "Deterministic Row Ordering: Unsorted must be FATAL ERROR (Exit 2), not warning" | YES - Updated Section 2.5 Step 5 |
| G2.2 | "Repo Root Resolution: Explicitly define method for resolving project root" | YES - Added get_repo_root() in Section 2.4 |
| G2.3 | "Add --ignore-cols argument for timestamp fields" | YES - Added to Section 2.5 |
| G2.4 | "CI output to GitHub Step Summary" | NOTED - Implementation detail |

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| Gemini 3 Pro #1 | 2026-01-29 | REVISE | SecurityError, row ordering, exit codes |
| Gemini 3 Pro #2 | 2026-01-30 | APPROVED | Sorting must be fatal, repo root resolution |

**Final Status:** APPROVED
