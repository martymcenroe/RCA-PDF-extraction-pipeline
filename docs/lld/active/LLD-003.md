# 10003 - Feature: Preserve Original Column Headers in CSV Output

## 1. Context & Goal
* **Issue:** #3
* **Objective:** Update CSV generation to use original PDF column headers verbatim instead of canonical names, with CSV injection protection
* **Status:** Draft
* **Related Issues:** #4 (blocked by), #5 (related)
* **Effort Estimate:** S/M (Small to Medium)

### Open Questions
*Questions that need clarification before or during implementation. Remove when resolved.*

- [ ] Should we support a CLI flag to toggle between original and canonical headers? *(Deferred to future issue)*
- [ ] How should headers with embedded newlines be handled (flatten to space)?
- [ ] Should a `--no-sanitize` flag be supported for trusted environments? *(Suggestion: default to safe, defer flag)*

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describe exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/models.py` | Modify | Add `original_headers: list[str]` field to Table dataclass |
| `src/table_extractor.py` | Modify | Capture original header text during extraction |
| `src/csv_writer.py` | Add | New module for CSV output with header preservation |
| `src/csv_sanitizer.py` | Add | New module for CSV injection protection |
| `tests/test_header_preservation.py` | Add | Unit tests for header preservation |
| `tests/test_csv_injection.py` | Add | Unit tests for CSV injection protection |
| `tests/fixtures/mock_table.json` | Add | Static Table fixture for offline development |

### 2.2 Offline Development Strategy

**Mock Mode:** The `csv_writer` and `csv_sanitizer` modules can be developed and tested independently of the PDF extraction pipeline using static fixtures.

```python
# tests/fixtures/mock_table.json - Static Table object for offline dev
{
    "original_headers": ["Sample No.", "Depth (ft)", "=Formula", "@Mention"],
    "canonical_headers": ["sample_number", "depth_feet", "formula_col", "mention_col"],
    "rows": [
        {"sample_number": "6-1", "depth_feet": "9580.5", ...},
        ...
    ]
}
```

**Development Workflow:**
1. Create `tests/fixtures/mock_table.json` with representative headers (including edge cases)
2. Develop `csv_sanitizer.py` using fixture - no PDF extraction needed
3. Develop `csv_writer.py` using fixture - no PDF extraction needed
4. Integration test with real PDF extraction as final step

### 2.3 Dependencies

*New packages, APIs, or services required.*

```toml
# No new dependencies - uses Python standard library csv module
```

### 2.4 Data Structures

```python
# Pseudocode - NOT implementation
@dataclass
class Table:
    original_headers: list[str]   # Headers as they appear in PDF
    canonical_headers: list[str]  # Normalized headers for code access
    rows: list[dict[str, str]]    # Rows keyed by canonical headers
```

### 2.5 Function Signatures

```python
# src/csv_sanitizer.py
class SanitizationError(Exception):
    """Raised when header sanitization fails unexpectedly."""
    pass

def sanitize_header(header: str) -> str:
    """Escape formula characters in header to prevent CSV injection.

    Raises:
        SanitizationError: If sanitization fails (e.g., None input, encoding error)
    """
    ...

# src/csv_writer.py
def write_csv(table: Table, output_path: Path) -> None:
    """Write table to CSV using original headers with injection protection.

    Raises:
        SanitizationError: If any header fails sanitization (Fail Closed)
    """
    ...
```

### 2.6 Logic Flow (Pseudocode)

```
1. Extract table from PDF
2. Store original header text in table.original_headers
3. Create canonical mapping for internal use
4. When writing CSV:
   a. For each header in original_headers:
      - Apply sanitize_header() for injection protection
   b. Write sanitized headers as first row
   c. Write data rows using canonical key mapping
```

### 2.7 Technical Approach

* **Module:** `src/csv_writer.py`, `src/csv_sanitizer.py`
* **Pattern:** Dual-header architecture (original for output, canonical for code)
* **Key Decisions:**
  - Use Python csv module with QUOTE_MINIMAL for proper escaping
  - Prepend `'` to headers starting with `=`, `@`, `+`, `-` for Excel safety
  - Raise `SanitizationError` on failure (Fail Closed)

## 3. Requirements

*What must be true when this is done. These become acceptance criteria.*

1. CSV headers match PDF headers exactly (before sanitization)
2. Headers starting with formula characters (`=`, `@`, `+`, `-`) are escaped with leading `'`
3. Internal code can still access data via canonical keys
4. All PDF processing occurs locally with no external API calls

## 4. Alternatives Considered

| Option | Pros | Cons | Decision |
|--------|------|------|----------|
| Original headers only | Simple, matches PDF | Awkward for code access | **Rejected** |
| Canonical headers only | Clean code | Doesn't match PDF (assignment fail) | **Rejected** |
| Dual-header architecture | Best of both worlds | Slight complexity | **Selected** |

**Rationale:** Dual headers allow preserving original text for output while maintaining clean canonical names for programmatic access.

## 5. Data & Fixtures

### 5.1 Data Sources

| Attribute | Value |
|-----------|-------|
| Source | W20552.pdf (local file) |
| Format | PDF with embedded tables |
| Size | ~50 pages, 138 samples |
| Refresh | Manual (static document) |
| Copyright/License | Assignment material |

### 5.2 Data Pipeline

```
PDF ──pdfplumber──► Table extraction ──sanitize──► CSV output
```

### 5.3 Test Fixtures

| Fixture | Source | Notes |
|---------|--------|-------|
| Mock headers with formula chars | Generated | Test `=SUM`, `@mention`, `+value` |
| Mock headers with commas | Generated | Test CSV quoting |

### 5.4 Deployment Pipeline

Local development only - no deployment pipeline needed.

## 6. Diagram

N/A - Simple data transformation, no complex flow.

## 7. Security Considerations

| Concern | Mitigation | Status |
|---------|------------|--------|
| CSV injection | Prepend `'` to formula characters | TODO |
| Path traversal | Validate output paths | TODO |

**Fail Mode:** Fail Closed - If sanitization fails, raise `SanitizationError` and abort CSV write rather than produce unsafe output.

**Fail-Safe Mechanism:**
```python
try:
    sanitized = sanitize_header(header)
except SanitizationError as e:
    logger.error(f"Sanitization failed for header '{header}': {e}")
    raise  # Propagate to abort write
```

### 7.1 Logging Strategy

| Event | Level | Message Format |
|-------|-------|----------------|
| Sanitization success | DEBUG | `Sanitized header: '{original}' -> '{sanitized}'` |
| Formula char escaped | INFO | `Escaped formula character in header: '{header}'` |
| Sanitization failure | ERROR | `Sanitization failed for header '{header}': {error}` |
| Write aborted | ERROR | `CSV write aborted due to sanitization failure` |

## 8. Performance Considerations

| Metric | Budget | Approach |
|--------|--------|----------|
| Memory | < 50MB | Stream rows, don't load all in memory |
| Latency | < 5s | Single-pass write |

**Bottlenecks:** None expected for 138-row dataset.

## 9. Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Header mismatch between pages | Med | Low | Use #5 normalization first |
| Encoding issues on Windows | Low | Med | Use UTF-8 with BOM |

## 10. Verification & Testing

### 10.1 Test Scenarios

| ID | Scenario | Type | Input | Expected Output | Pass Criteria |
|----|----------|------|-------|-----------------|---------------|
| 010 | Normal headers preserved | Auto | "Depth (ft)" | "Depth (ft)" in CSV | Exact match |
| 020 | Formula char escaped | Auto | "=SUM(A1)" | "'=SUM(A1)" | Leading quote added |
| 030 | Comma in header quoted | Auto | "Perm, Air" | Proper CSV quoting | Opens correctly in Excel |
| 040 | Canonical access works | Auto | table.rows[0] | Access via canonical key | No KeyError |

### 10.2 Test Commands

```bash
# Run all automated tests
pytest tests/test_header_preservation.py tests/test_csv_injection.py -v
```

### 10.3 Manual Tests (Only If Unavoidable)

| ID | Scenario | Why Not Automated | Steps |
|----|----------|-------------------|-------|
| 050 | Excel formula execution | Requires Excel application | Open CSV in Excel, verify no formula runs |

## 11. Definition of Done

### Code
- [ ] Implementation complete and linted
- [ ] Code comments reference this LLD

### Tests
- [ ] All test scenarios pass
- [ ] Test coverage meets threshold

### Documentation
- [ ] LLD updated with any deviations
- [ ] Implementation Report completed
- [ ] Test Report completed if applicable

### Review
- [ ] Code review completed
- [ ] User approval before closing issue

---

## Appendix: Review Log

*Track all review feedback with timestamps and implementation status.*

### Gemini 3 Pro Review #1 (APPROVED)

**Timestamp:** 2026-01-29
**Reviewer:** Gemini 3 Pro (Senior Software Architect & AI Governance Lead)
**Verdict:** APPROVED

#### Comments

| ID | Comment | Implemented? |
|----|---------|--------------|
| G1.1 | "Offline Development (CRITICAL): Define Mock Mode or static fixtures for developing csv_writer and csv_sanitizer without re-running PDF extraction" | YES - Added Section 2.2 with mock_table.json fixture |
| G1.2 | "Logging Strategy: Ensure sanitization failures are logged at ERROR level" | YES - Added Section 7.1 Logging Strategy |
| G1.3 | "Fail-Safe Strategy: Define custom SanitizationError exception" | YES - Added to Section 2.5 Function Signatures |
| G1.4 | "Consider --no-sanitize flag for trusted environments" | NOTED - Added to Open Questions as deferred |
| G1.5 | "Add T-shirt size estimate" | YES - Added S/M to Section 1 |

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| Gemini 3 Pro #1 | 2026-01-29 | APPROVED | Offline dev, logging, fail-safe |

**Final Status:** APPROVED
