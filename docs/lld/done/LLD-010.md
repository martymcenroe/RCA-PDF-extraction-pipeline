# 10010 - Feature: Fix Pylint Audit Integration

## 1. Context & Goal
* **Issue:** #10
* **Objective:** Fix the `check_q2_code_clean()` function in `scripts/audit.py` to reliably parse pylint output
* **Status:** Approved
* **Related Issues:** #7 (Pylint score improvement target)

### Open Questions
*Questions that need clarification before or during implementation. Remove when resolved.*

- [ ] Should we consider switching to Ruff if Pylint continues to be problematic?
- [ ] What is the minimum acceptable Pylint score? (Proposed: 6.0 WARN, 8.0 PASS)

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describe exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `scripts/audit.py` | Modify | Fix `check_q2_code_clean()` with improved parsing |
| `pyproject.toml` | Modify | Add `pylint>=3.0.0` to dev dependencies |

### 2.2 Offline Development Strategy

**Pure Parser Function:** Extract the regex parsing logic into a pure function that can be tested independently without subprocess execution.

```python
# tests/fixtures/pylint_outputs.py - Static text fixtures for offline dev

PYLINT_OUTPUT_GOOD = """
************* Module core_analysis_minimal
src/core_analysis_minimal.py:1:0: C0114: Missing module docstring (missing-module-docstring)

------------------------------------------------------------------
Your code has been rated at 8.50/10 (previous run: 7.00/10, +1.50)
"""

PYLINT_OUTPUT_NEGATIVE = """
Your code has been rated at -2.50/10
"""

PYLINT_OUTPUT_NO_SCORE = """
Some random output without a score line
"""
```

**Development Workflow:**
1. Create static text fixtures representing various pylint outputs
2. Develop `parse_pylint_score()` using fixtures - no subprocess needed
3. Test with `unittest.mock.patch` on `subprocess.run` to inject fixtures
4. Integration test with real pylint as final step

### 2.3 Dependencies

*New packages, APIs, or services required.*

```toml
[project.optional-dependencies]
dev = [
    "pylint>=3.0.0,<4.0.0",  # Pinned to prevent output format changes
    # ... other dev deps
]
```

### 2.4 Data Structures

```python
# No new data structures - bug fix only
```

### 2.5 Function Signatures

```python
# scripts/audit.py - Updated functions

def parse_pylint_score(output: str) -> float | None:
    """
    Parse pylint score from output text (PURE FUNCTION - no side effects).

    Uses re.search to find score anywhere in output for robustness.

    Args:
        output: Combined stdout+stderr from pylint

    Returns:
        Score as float, or None if not found
    """
    ...

def check_q2_code_clean() -> tuple[str, str, str]:
    """
    Check code quality using Pylint.

    Separates subprocess execution from parsing for testability.

    Returns:
        tuple: (status, description, evidence)
        - status: "PASS" (>=8.0), "WARN" (6.0-7.9), "FAIL" (<6.0), "SKIP" (error)
    """
    ...
```

### 2.6 Logic Flow (Pseudocode)

```
check_q2_code_clean():
1. Pre-check: Run `pylint --version`
   - IF not installed: return SKIP with helpful message
2. Run pylint on source files with --score=y
   - Use encoding="utf-8", errors="replace" for Windows
   - Use timeout=120s for larger codebases
3. Concatenate stdout + stderr
4. Call parse_pylint_score(output) - PURE FUNCTION
5. Handle non-zero exit codes (pylint returns non-zero for warnings)
6. Return appropriate status:
   - score >= 8.0: PASS
   - score >= 6.0: WARN
   - score < 6.0: FAIL
   - score is None: SKIP with debug evidence

parse_pylint_score(output):
1. Use re.search (not re.match) for robustness
2. Pattern: r'Your code has been rated at (-?[\d.]+)/10'
3. Handle negative scores (pylint can return negative)
4. Return float score or None if not found
```

### 2.7 Technical Approach

* **Module:** `scripts/audit.py`
* **Pattern:** Defensive parsing with comprehensive error handling
* **Key Decisions:**
  - Pre-check for pylint availability
  - Concatenate stdout+stderr for robust parsing
  - Handle negative scores in regex
  - Include evidence snippet on parse failure for debugging

## 3. Requirements

*What must be true when this is done. These become acceptance criteria.*

1. Running `python -m pylint --version` succeeds after `pip install -e ".[dev]"`
2. Q2 check returns PASS/WARN/FAIL with score when pylint works
3. Q2 check returns SKIP with actionable message when pylint not installed
4. Q2 check handles pylint non-zero exit codes without failing
5. Parse failure includes evidence snippet for debugging
6. Windows users can run audit without encoding errors

## 4. Alternatives Considered

| Option | Pros | Cons | Decision |
|--------|------|------|----------|
| Keep current broken impl | None | Doesn't work | **Rejected** |
| Switch to Ruff | Faster, simpler | Different tool, migration effort | Future consideration |
| Fix Pylint parsing | Uses existing tool | Pylint quirks | **Selected** |

**Rationale:** Fix the existing tool rather than switch mid-project. Ruff migration can be a future enhancement.

## 5. Data & Fixtures

### 5.1 Data Sources

| Attribute | Value |
|-----------|-------|
| Source | Pylint CLI output |
| Format | Text (stdout/stderr) |
| Size | < 1KB |
| Refresh | Per audit run |
| Copyright/License | N/A |

### 5.2 Data Pipeline

```
Source files ──pylint──► stdout/stderr ──parse──► Score ──evaluate──► PASS/WARN/FAIL
```

### 5.3 Test Fixtures

| Fixture | Source | Notes |
|---------|--------|-------|
| `PYLINT_OUTPUT_GOOD` | Generated | Score 8.50/10 |
| `PYLINT_OUTPUT_LOW` | Generated | Score 5.00/10 |
| `PYLINT_OUTPUT_NEGATIVE` | Generated | Score -2.50/10 |
| `PYLINT_OUTPUT_NO_SCORE` | Generated | No score line present |
| `PYLINT_OUTPUT_ERROR` | Generated | Pylint crash/error output |

**Testing Strategy:**
```python
# Use unittest.mock.patch to inject fixtures
from unittest.mock import patch, MagicMock

def test_parse_pylint_score_good():
    """Test pure parsing function directly."""
    score = parse_pylint_score(PYLINT_OUTPUT_GOOD)
    assert score == 8.50

@patch('subprocess.run')
def test_check_q2_with_mock(mock_run):
    """Test full function with mocked subprocess."""
    mock_run.return_value = MagicMock(
        stdout=PYLINT_OUTPUT_GOOD,
        stderr="",
        returncode=0
    )
    status, desc, evidence = check_q2_code_clean()
    assert status == "PASS"
```

### 5.4 Deployment Pipeline

N/A - Development tooling fix.

## 6. Diagram

N/A - Simple bug fix, no architectural changes.

## 7. Security Considerations

| Concern | Mitigation | Status |
|---------|------------|--------|
| No security implications | Development-only tooling | N/A |

**Fail Mode:** Fail Open - If pylint fails, return SKIP and continue audit.

## 8. Performance Considerations

| Metric | Budget | Approach |
|--------|--------|----------|
| Timeout | 120s | Increased from 60s for larger codebases |

**Bottlenecks:** Pylint can be slow on large files; timeout handles this.

## 9. Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Pylint output format changes | Med | Low | Regex handles common patterns |
| Windows encoding issues | Med | Med | errors="replace" parameter |
| Timeout on large repos | Low | Low | 120s should be sufficient |

## 10. Verification & Testing

### 10.1 Test Scenarios

| ID | Scenario | Type | Input | Expected Output | Pass Criteria |
|----|----------|------|-------|-----------------|---------------|
| 010 | Parse good score (pure fn) | Auto | PYLINT_OUTPUT_GOOD | 8.50 | Correct float |
| 020 | Parse negative score (pure fn) | Auto | PYLINT_OUTPUT_NEGATIVE | -2.50 | Handles negative |
| 030 | Parse no score (pure fn) | Auto | PYLINT_OUTPUT_NO_SCORE | None | Returns None |
| 040 | Full check - good (mocked) | Auto | Mock subprocess | PASS, score shown | >= 8.0 |
| 050 | Full check - low (mocked) | Auto | Mock subprocess | WARN or FAIL | Score shown |
| 060 | Full check - not installed | Auto | Mock subprocess error | SKIP, helpful msg | Clear instruction |
| 070 | Full check - parse failure | Auto | Mock unknown output | SKIP, evidence shown | Debug info |

### 10.2 Test Commands

```bash
# Verify current failure
python scripts/audit.py --verbose

# Check pylint installation
python -m pylint --version

# Install dev dependencies
pip install -e ".[dev]"

# Run pylint manually to see output format
python -m pylint src/core_analysis_minimal.py --score=y

# After fix, re-run audit
python scripts/audit.py --verbose
```

### 10.3 Manual Tests (Only If Unavoidable)

| ID | Scenario | Why Not Automated | Steps |
|----|----------|-------------------|-------|
| 060 | Fresh env test | Requires clean virtualenv | Uninstall pylint, run audit, verify SKIP message |

## 11. Definition of Done

### Code
- [ ] `check_q2_code_clean()` rewritten with improved error handling
- [ ] Pylint version check added before main execution
- [ ] Both stdout and stderr checked for score output
- [ ] Encoding parameters added for Windows compatibility

### Tests
- [ ] All test scenarios pass
- [ ] Manual fresh-env test passes

### Documentation
- [ ] LLD updated with any deviations
- [ ] Implementation Report completed
- [ ] Comment in code explaining pylint exit code behavior

### Review
- [ ] Code review completed
- [ ] Q2 no longer shows "Could not parse pylint output"

---

## Appendix: Review Log

*Track all review feedback with timestamps and implementation status.*

### Gemini 3 Pro Review #1 (APPROVED)

**Timestamp:** 2026-01-30
**Reviewer:** Gemini 3 Pro (Senior Software Architect & AI Governance Lead)
**Verdict:** APPROVED

#### Comments

| ID | Comment | Implemented? |
|----|---------|--------------|
| G1.1 | "Offline Development (CRITICAL): Extract regex into pure function parse_pylint_score()" | YES - Added Section 2.2 and 2.5 |
| G1.2 | "Test Integrity: Use unittest.mock.patch on subprocess.run" | YES - Added to Section 5.3 |
| G1.3 | "Use re.search instead of re.match for robustness" | YES - Updated Section 2.6 |
| G1.4 | "Pin pylint version to prevent format changes" | YES - Updated to pylint>=3.0.0,<4.0.0 |

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| Gemini 3 Pro #1 | 2026-01-30 | APPROVED | Extract pure parser function |

**Final Status:** APPROVED
