# LLD-013: Extract Headers from PDF (Bug Fix)

## 1. Context & Goal

* **Issue:** #13
* **Objective:** Extract table headers dynamically from the PDF instead of using hardcoded strings
* **Status:** Draft
* **Related Issues:** #3, #5
* **Effort Estimate:** S (Small) - targeted fix, not full header normalization

### Problem Statement

The current `ORIGINAL_HEADERS` constant contains manually typed abbreviations that don't match the actual PDF:

| Current (Wrong) | Actual PDF |
|-----------------|------------|
| `Permeability (md) \| Air` | `Permeability, millidarcys to Air` |
| `Permeability (md) \| Klink` | `Permeability, millidarcys Klinkenberg` |
| `Porosity (%) \| Ambient` | `Porosity, percent Ambient` |
| `Grain Density (g/cc)` | `Grain Density, gm/cc` |
| `Fluid Saturations (%) \| Water` | `Fluid Saturations, percent Water` |

## 2. Proposed Changes

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/core_analysis.py` | Modify | Add `_extract_headers_from_db()` method, replace hardcoded headers |
| `data/output/spec/core_analysis.csv` | Modify | Regenerate with correct headers |
| `tests/test_header_extraction.py` | Add | Tests for header extraction |

### 2.2 Technical Approach

**Strategy:** Extract header text spans from the database, group by position, flatten into column headers.

The PDF table headers on page 39 span 4 rows (yâ‰ˆ181-215):
```
y=181: "Fluid"
y=193: "Sample", "Permeability,", "Porosity,", "Grain", "Saturations,"
y=204: "Core", "Sample", "Depth,", "millidarcys", "percent", "Density,", "percent"
y=215: "Number", "Number", "feet", "to Air", "Klinkenberg", "Ambient", "NCS", "gm/cc", "Water", "Oil", "Total"
```

**Algorithm:**
1. Query `text_spans` table for page 39, y between 170-230
2. Group spans into columns by x-position (using clustering with tolerance)
3. For each column, concatenate text from top to bottom with space separator
4. Return list of flattened headers

### 2.3 Function Signature

```python
def _extract_headers_from_db(self, page_num: int = 39) -> list[str]:
    """
    Extract and flatten multi-row table headers from the database.

    Args:
        page_num: Page number containing the table headers (default: 39)

    Returns:
        List of flattened header strings in column order.

    Example:
        ["Core Number", "Sample Number", "Depth, feet",
         "Permeability, millidarcys to Air", ...]
    """
```

### 2.4 Column Clustering Logic

```python
# Pseudocode
COLUMN_TOLERANCE = 30  # pixels - spans within this x-range are same column

def cluster_by_x(spans: list[tuple]) -> dict[int, list]:
    """Group spans into columns based on x-position."""
    columns = {}  # center_x -> list of spans
    for span in sorted(spans, key=lambda s: s.x0):
        # Find existing column within tolerance
        matched = False
        for center_x in columns:
            if abs(span.x0 - center_x) < COLUMN_TOLERANCE:
                columns[center_x].append(span)
                matched = True
                break
        if not matched:
            columns[span.x0] = [span]
    return columns
```

### 2.5 Data Row Mapping

After extracting headers, map them to `CoreSample` fields:

| Extracted Header | CoreSample Field |
|-----------------|------------------|
| Core Number | core_number |
| Sample Number | sample_number |
| Depth, feet | depth_feet |
| Permeability, millidarcys to Air | permeability_air_md |
| Permeability, millidarcys Klinkenberg | permeability_klink_md |
| Porosity, percent Ambient | porosity_ambient_pct |
| Porosity, percent NCS | porosity_ncs_pct |
| Grain Density, gm/cc | grain_density_gcc |
| Fluid Saturations, percent Water | saturation_water_pct |
| Fluid Saturations, percent Oil | saturation_oil_pct |
| Fluid Saturations, percent Total | saturation_total_pct |

## 3. Requirements

1. Headers extracted from PDF match actual table headers exactly
2. Multi-row headers are flattened with space separator
3. Column order matches data column order
4. `Page Number` header is appended (not in PDF, added by extraction)
5. Backward compatible - existing CSV output format unchanged except header text

## 4. Test Scenarios

| ID | Scenario | Input | Expected Output |
|----|----------|-------|-----------------|
| T01 | Extract headers from page 39 | Database | 11 headers matching PDF |
| T02 | First header is "Core Number" | Database | headers[0] == "Core Number" |
| T03 | Permeability header full text | Database | "Permeability, millidarcys to Air" |
| T04 | Klinkenberg spelled out | Database | Contains "Klinkenberg" not "Klink" |
| T05 | Output CSV has correct headers | Full run | First line matches expected |

## 5. Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Different PDFs have different header structure | This fix is specific to W20552.pdf; future work for generalization |
| Column clustering produces wrong groupings | Use data row column positions to validate |

## 6. Definition of Done

- [ ] Headers extracted from database, not hardcoded
- [ ] CSV output headers match PDF exactly
- [ ] Tests pass
- [ ] Baseline regenerated
